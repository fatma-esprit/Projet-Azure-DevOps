trigger:
- main

pool:
  name: Default  # Ton agent auto-h√©berg√©

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '12.x'  # Utilisation de Node.js 12 compatible avec Angular 6
  displayName: 'Installer Node.js 12'

- script: |
    echo "üîç V√©rification du r√©pertoire de travail"
    cd $(Build.SourcesDirectory)
    dir
  workingDirectory: $(Build.SourcesDirectory)
  displayName: 'Afficher le r√©pertoire et fichiers (Windows)'

- script: |
    echo "‚ôªÔ∏è Nettoyage du cache et des d√©pendances"
    rmdir /s /q node_modules
    del package-lock.json
    npm cache clean --force
    npm install --prefix $(Build.SourcesDirectory) --legacy-peer-deps
    npm rebuild node-sass
  workingDirectory: $(Build.SourcesDirectory)
  displayName: 'Installer les d√©pendances'

- script: |
    echo "üöÄ Installation de Angular CLI"
    npm install -g @angular/cli@6.0.8 --legacy-peer-deps --force
    ng version
  displayName: 'Installer Angular CLI'

- script: |
    echo "üîß V√©rification et r√©installation des d√©pendances Angular"
    cd $(Build.SourcesDirectory)
    npm install @angular/animations@6.0.3 \
                @angular/common@6.0.3 \
                @angular/compiler@6.0.3 \
                @angular/core@6.0.3 \
                @angular/forms@6.0.3 \
                @angular/http@6.0.3 \
                @angular/platform-browser@6.0.3 \
                @angular/platform-browser-dynamic@6.0.3 \
                @angular/router@6.0.3 \
                rxjs@6.0.0 --legacy-peer-deps --force
  workingDirectory: $(Build.SourcesDirectory)
  displayName: 'Forcer l‚Äôinstallation de @angular/core et rxjs'

- script: |
    echo "üèóÔ∏è Lancement du build Angular"
    cd $(Build.SourcesDirectory)
    ng build --configuration=production
  workingDirectory: $(Build.SourcesDirectory)
  displayName: 'Construire l‚Äôapplication Angular'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.SourcesDirectory)/dist'
    artifactName: 'drop'
  displayName: 'Publier les artefacts de build'
