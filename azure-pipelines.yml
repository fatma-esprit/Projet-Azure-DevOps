pool:
  name: Default  
  demands:
    - Agent.Name -equals AgentDevops  

stages:
- stage: Build
  displayName: "ğŸ”§ Construction"
  jobs:
  - job: Build_App
    displayName: "ğŸ“¦ Build de l'application"
    steps:

    # ğŸ“Œ Ã‰tape 1 : Installer et configurer Java 11
    - task: JavaToolInstaller@1
      inputs:
        versionSpec: '11'
        jdkArchitecture: 'x64'
        jdkSource: 'PreInstalled'
      displayName: "Installer Java 11"

    # ğŸ“Œ Ã‰tape 2 : VÃ©rifier la version de Java
    - script: |
        echo "ğŸ› ï¸ Configuration de Java 11"
        echo "JAVA_HOME = $JAVA_HOME"
        java -version
      displayName: "VÃ©rifier la version de Java"

    # ğŸ“Œ Ã‰tape 3 : PrÃ©parer l'analyse SonarCloud
    - task: SonarCloudPrepare@1
      inputs:
        SonarCloud: "SonarCloud"
        organization: "fatma-esprit"
        projectKey: "fatma-esprit_Projet-Azure-DevOps"
        projectName: "Projet Azure DevOps"
        scannerMode: "CLI"
        extraProperties: |
          sonar.projectKey=fatma-esprit_Projet-Azure-DevOps
          sonar.organization=fatma-esprit
          sonar.host.url=https://sonarcloud.io
          sonar.sources=.

    # ğŸ“Œ Ã‰tape 4 : Installer Node.js
    - task: NodeTool@0
      inputs:
        versionSpec: '12.x'
      displayName: 'Installer Node.js 12'

    # ğŸ“Œ Ã‰tape 5 : Nettoyer les dÃ©pendances
    - script: |
        echo "ğŸ§¹ Nettoyage des dÃ©pendances"
        rm -rf package-lock.json node_modules
        npm cache clean --force
      workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Nettoyer les dÃ©pendances'

    # ğŸ“Œ Ã‰tape 6 : Installer les dÃ©pendances
    - script: |
        echo "ğŸ“¦ Installation des dÃ©pendances"
        npm install --legacy-peer-deps
        npm rebuild node-sass
      workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Installer les dÃ©pendances'

    # ğŸ“Œ Ã‰tape 7 : Installer Angular CLI
    - script: |
        echo "âš™ï¸ Installation d'Angular CLI 6"
        npm install -g @angular/cli@6.0.8 --legacy-peer-deps
      displayName: 'Installer Angular CLI'

    # ğŸ“Œ Ã‰tape 8 : VÃ©rifier les versions
    - script: |
        echo "ğŸ” VÃ©rification de @angular/core et rxjs"
        npm list @angular/core rxjs || true
      workingDirectory: $(Build.SourcesDirectory)
      displayName: 'VÃ©rifier @angular/core et rxjs'

    # ğŸ“Œ Ã‰tape 9 : Forcer lâ€™installation de @angular/core et rxjs
    - script: |
        echo "ğŸš€ ForÃ§age de l'installation de @angular/core et rxjs"
        npm install @angular/core@6.0.3 rxjs@6.0.0 --legacy-peer-deps
      workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Forcer lâ€™installation de @angular/core et rxjs'

    # ğŸ“Œ Ã‰tape 10 : Construire lâ€™application Angular
    - script: |
        echo "âš™ï¸ DÃ©sactivation temporaire des erreurs TypeScript strictes"
        ng build --configuration production --aot=false --build-optimizer=false
      workingDirectory: $(Build.SourcesDirectory)
      displayName: 'Construire lâ€™application Angular'

    # ğŸ“Œ Ã‰tape 11 : ExÃ©cuter lâ€™analyse SonarCloud
    - task: SonarCloudAnalyze@1
      displayName: "ğŸ” ExÃ©cuter l'analyse SonarCloud"

    # ğŸ“Œ Ã‰tape 12 : (Optionnel) Publier les rÃ©sultats SonarCloud (DÃ©conseillÃ©)
    # - task: SonarCloudPublish@1
    #   inputs:
    #     pollingTimeoutSec: '300'
    #   displayName: "ğŸ“Š Publier les rÃ©sultats SonarCloud"

    # ğŸ“Œ Ã‰tape 13 : ExÃ©cuter les tests unitaires
    - script: |
        echo "ğŸ§ª ExÃ©cution des tests"
        npm install --legacy-peer-deps
        npm run test
      displayName: 'ExÃ©cuter les tests unitaires'

    # ğŸ“Œ Ã‰tape 14 : Publier les rÃ©sultats des tests
    - task: PublishTestResults@2
      inputs:
        testResultsFiles: 'srctest-results/TEST-results.xml'
        testRunTitle: 'RÃ©sultats des tests du frontend'
        mergeTestResults: true
        failTaskOnFailedTests: true
      condition: always()
      displayName: 'Publier les rÃ©sultats des tests'

    # ğŸ“Œ Ã‰tape 15 : Exporter les variables dâ€™environnement
    - powershell: |
        gci env:* | sort-object name | Format-Table -AutoSize | Out-File $env:BUILD_ARTIFACTSTAGINGDIRECTORY/environment-variables.txt
      displayName: 'Exporter les variables dâ€™environnement'

    # ğŸ“Œ Ã‰tape 16 : Copier les fichiers de build
    - task: CopyFiles@2
      inputs:
        sourceFolder: '$(Build.SourcesDirectory)'
        contents: '**/$(BuildConfiguration)/**/?(*.exe|*.dll|*.pdb)'
        targetFolder: '$(Build.ArtifactStagingDirectory)'
      displayName: 'Copier les fichiers de build'

    # ğŸ“Œ Ã‰tape 17 : Publier les artefacts de build
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: drop
      displayName: 'Publier les artefacts de build'
